const express = require('express');
const mongoose = require('mongoose');

const app = express();
const PORT = 3001;

// Option 1: Use MongoDB Atlas (recommended for production)
// Get your connection string from https://cloud.mongodb.com
// const MONGO_URI = 'mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/your-database-name?retryWrites=true&w=majority';

// Option 2: Use local MongoDB instance
const MONGO_URI = 'mongodb://localhost:27017/sample_data';

// Option 3: Use MongoDB with authentication
// const MONGO_URI = 'mongodb://username:password@localhost:27017/your-database-name';

mongoose.connect(MONGO_URI)
  .then(() => console.log('✅ Connected to MongoDB'))
  .catch((err) => console.error('❌ MongoDB connection error:', err));

// Enable JSON parsing middleware
app.use(express.json());

const rawDataSchema = new mongoose.Schema({}, { strict: false });
const RawData = mongoose.model('RawData', rawDataSchema, 'raw_data');

app.get('/raw-data', async (req, res) => {
  try {
    const raw_data = await RawData.find();
    res.json(raw_data);
  } catch (err) {
    console.error('Error fetching data:', err);
    res.status(500).json({ error: 'Failed to fetch data' });
  }
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// Handle graceful shutdown
process.on('SIGINT', async () => {
  console.log('🔄 Shutting down gracefully...');
  await mongoose.connection.close();
  console.log('✅ MongoDB connection closed');
  process.exit(0);
});

app.listen(PORT, () => {
  console.log(`🚀 Server is running on http://localhost:${PORT}`);
  console.log(`📊 Raw data endpoint: http://localhost:${PORT}/raw-data`);
  console.log(`❤️  Health check: http://localhost:${PORT}/health`);
});

// Export for testing
module.exports = app;